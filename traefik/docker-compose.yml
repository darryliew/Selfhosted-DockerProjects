version: '3.9'
services:
  traefik:
    container_name: traefik
    image: traefik:latest
    ports:
      - 80:80
      - 443:443
      #- 8080:8080  # traefik drashboard port
    volumes:
      - ${APP_DIR}/traefik.yml:/traefik.yml:ro  # traefik api config file
      - ${APP_DIR}/rules:/rules:ro  # traefik optional files
      - ${APP_DIR}/letsencrypt:/letsencrypt # LetsEncrypt ACME Config
    networks:
      - proxy
    labels:
      traefik.enable: true   # Enable Traefik reverse proxy for the Traefik dashboard.

      # global redirect to https
      traefik.http.routers.http-catchall.rule: hostregexp(`{host:.+}`)
      traefik.http.routers.http-catchall.entrypoints: http
      traefik.http.routers.http-catchall.middlewares: redirect-to-https

      # middleware redirect
      traefik.http.middlewares.redirect-to-https.redirectscheme.scheme: https
      traefik.http.middlewares.redirect-to-https.redirectscheme.permanent: true

      # redirect root to www
      traefik.http.routers.root.rule: host(`${DOMAIN}.com`)
      traefik.http.routers.root.entrypoints: https
      traefik.http.routers.root.middlewares: redirect-root-to-www
      traefik.http.routers.root.tls: true

      # middleware redirect root to www
      traefik.http.middlewares.redirect-root-to-www.redirectregex.regex: ^https://${DOMAIN}\\.com/(.*)
      traefik.http.middlewares.redirect-root-to-www.redirectregex.replacement: https://www.${DOMAIN}.com/$${1}

      # IP filtering
      traefik.http.routers.service-router-name.middlewares: whitelist@file

      # Watchtower Update
      com.centurylinklabs.watchtower.enable: true
    environment:
      TZ: ${CONTAINER_TIME_ZONE}
      CF_DNS_API_TOKEN: ${CLOUDFLARE_TOKEN}
    restart: unless-stopped
    depends_on:
      - socket-proxy

  socket-proxy:
    container_name: traefik-socket-proxy
    image: tecnativa/docker-socket-proxy
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - proxy
    environment:
      CONTAINERS: 1
    privileged: true
    restart: unless-stopped
    labels:
      # Watchtower update
      com.centurylinklabs.watchtower.enable: true

networks:
  proxy:
    driver: bridge
    external: true
